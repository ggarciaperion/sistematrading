{% extends "base.html" %}
{% block title %}Dashboard Trader - Sistema de Trading de Dólares{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
body, .main-content {
    background: #fff !important;
    color: #181d22 !important;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.7rem 1.5rem;
}
.dashboard-header {
    font-size: 1.7rem;
    font-weight: 700;
    color: #181d22;
    letter-spacing: 1px;
    margin-bottom: 1.2rem;
    text-align: left;
}
.dashboard-section-title {
    font-size: 1.14rem;
    color: #b9a038;
    font-weight: 600;
    margin-bottom: 1rem;
    margin-top: 1.4rem;
    letter-spacing: .5px;
    text-align: left;
    display: block;    
}
.month-selector-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.month-selector {
    border-radius: 0.5rem;
    border: 1.5px solid #b9a038;
    padding: 0.35em 1.1em;
    font-size: 1rem;
    font-weight: 500;
    background: #f7f7fa;
    color: #181d22;
    min-width: 140px;
    cursor: pointer;
}
.month-selector-label {
    color: #b9a038;
    font-weight: 600;
    font-size: 1rem;
}

/* Alineación: forzar que las tarjetas del row se alineen arriba y evitar offsets verticales */
.stats-row {
    display: flex;
    gap: 2.2rem;
    margin-bottom: 1.7rem;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: flex-start; /* align tops */
}
.stats-row > * {
    align-self: start; /* force each child to the top */
}

/* Shared sizing & visual weight so stats-card and progress-card match exactly */
.card-equal {
    background: #f7f7fa;
    color: #181d22;
    border-radius: 1.1rem;
    box-shadow: 0 1px 8px rgba(0,0,0,0.08);
    padding: 1.1rem 1.3rem 1.05rem 1.3rem;
    min-width: 180px;
    max-width: 240px;
    text-align: left;
    position: relative;
    border: 2px solid #ececec;
    margin-bottom: 0.7rem;
    margin-top: 0.7rem;
    transition: box-shadow 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    height: 120px;
    box-sizing: border-box;
}

/* Apply shared class to both card types */
.stats-card {
    flex: 1 1 200px;
}
.stats-card, .stats-card.card-equal {
    /* ensure the base visual uses the shared sizing */
}
.stats-card {
    /* keep existing selectors for icon/label/main-value */
}
.stats-card .icon {
    font-size: 1.7rem;
    color: #b9a038;
    margin-bottom: .25rem;
    margin-right: .35rem;
    display: inline-block;
    vertical-align: middle;
}
.stats-card .main-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.13rem;
    color: #181d22;
    line-height: 1.08;
}
.stats-card .label {
    font-size: 1.12rem;
    font-weight: 500;
    color: #4d4d4d;
    margin-bottom: .01rem;
    margin-top: .07rem;
}

/* Progress card should visually match stats-card exactly */
.progress-card {
    /* reuse the same sizing/visual weight rules */
    flex: 1 1 200px;
    background: #f7f7fa;
    color: #181d22;
    border-radius: 1.1rem;
    box-shadow: 0 1px 8px rgba(0,0,0,0.08);
    padding: 1.1rem 1.3rem 1.05rem 1.3rem;
    min-width: 180px;
    max-width: 240px;
    text-align: left;
    position: relative;
    border: 2px solid #ececec;
    margin-bottom: 0.7rem;
    margin-top: 0.7rem;
    transition: box-shadow 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: flex-start; /* left-align inner content */
    justify-content: center;
    height: 120px; /* ensure same height */
    box-sizing: border-box;
}

/* Progress internals styled to fit the same visual weight */
.progress-label {
    font-size: 1.12rem; /* same size as .label */
    font-weight: 600;
    color: #b9a038;
    margin-bottom: 0.6rem; /* space above the bar */
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.progress-bar-bg {
    width: 100%;
    height: 18px;
    background: #e9e9eb;
    border-radius: 1em;
    overflow: hidden;
    margin-bottom: 0.36rem;
    margin-top: 0;
    box-sizing: border-box;
}
.progress-bar-fg {
    height: 100%;
    background: linear-gradient(90deg, #b9a038 0%, #f3e2ae 100%);
    border-radius: 1em;
    transition: width 0.4s;
}

/* percentage text style similar to stats main-value but smaller */
#meta_progress_text {
    font-size: 1.01rem;
    font-weight: 600;
    color: #181d22;
    margin-top: 0.25rem;
}

/* ESTILO DESTACADO PARA LA TARJETA "META" (trader dashboard) */
.meta-card {
    background: linear-gradient(135deg, #fff4d9 0%, #fff9ee 100%);
    border: 2px solid #e6b945;
    box-shadow: 0 6px 18px rgba(230, 185, 66, 0.12);
    color: #2f2207;
    position: relative;
    overflow: hidden;
}
.meta-card .icon {
    color: #b97f00;
}
.meta-card .main-value {
    color: #2f2207;
    font-weight: 800;
}
/* Aplicar distintivo solo cuando la tarjeta es una stats-card con clase meta-card */
.stats-card.meta-card::after {
    content: "UTILIDAD";
    position: absolute;
    top: 8px;
    right: 10px;
    font-size: 0.68rem;
    font-weight: 700;
    color: #5a3200;
    background: rgba(255, 219, 138, 0.65);
    padding: 3px 8px;
    border-radius: 12px;
    letter-spacing: 0.6px;
}

/* Mantener progress-card.meta-card visual highlight but no label */
.progress-card.meta-card {
    background: linear-gradient(135deg, #fff4d9 0%, #fff9ee 100%);
    border: 2px solid #e6b945;
    box-shadow: 0 6px 18px rgba(230, 185, 66, 0.12);
    color: #2f2207;
}
.progress-card.meta-card .progress-label { color: #5a3200; }
.progress-card.meta-card .progress-bar-fg {
    background: linear-gradient(90deg, #b97f00 0%, #f3e2ae 100%);
}
.progress-card.meta-card::after {
    content: "";
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .dashboard-container { max-width: 98vw; padding: 1.1rem 0.3rem; }
    .stats-row { gap: 1.2rem; }
}
@media (max-width: 900px) {
    .dashboard-container { max-width: 100vw; }
    .stats-row { flex-direction: column; align-items: stretch;}
    .dashboard-header, .dashboard-section-title { text-align: center; }
    .stats-card { max-width: 100%; text-align: center; align-items: center;}
    .progress-card { max-width: 100%; align-items: center; }
    
    /* Ajustes responsivos para el selector de meses */
    .dashboard-section-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .month-selector-container {
        align-self: flex-end;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <i class="bi bi-bar-chart-fill"></i> Panel de Control
    </div>

    <!-- Estadísticas del Día -->
    <div class="dashboard-section-title"><i class="bi bi-calendar-day"></i> Estadísticas del Día</div>
    <div class="stats-row" id="stats-row-dia">
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-people-fill"></i></span>
            <div class="main-value" id="stat_clients_today">0</div>
            <div class="label">Clientes</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-cash-stack"></i></span>
            <div class="main-value" id="stat_operations_today">0</div>
            <div class="label">Operaciones</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-currency-dollar"></i></span>
            <div class="main-value" id="stat_usd_today">$ 0.00</div>
            <div class="label">Monto USD</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-currency-exchange"></i></span>
            <div class="main-value" id="stat_pen_today">S/ 0.00</div>
            <div class="label">Monto Soles</div>
        </div>
        <div class="stats-card editable-card card-equal" data-field="utilidad_dia">
            <span class="icon"><i class="bi bi-graph-up"></i></span>
            <span id="utilidad_dia_valor" class="main-value"></span>
            <div class="label">Utilidad hoy</div>
        </div>
    </div>

    <!-- Estadísticas del Mes -->
    <div class="dashboard-section-title">
        <span><i class="bi bi-calendar3"></i> Estadísticas del Mes</span>
        <div class="month-selector-container">
            <span class="month-selector-label">Mes:</span>
            <select id="monthSelector" class="month-selector">
                <!-- Las opciones se llenarán con JavaScript -->
            </select>
        </div>
    </div>
    <div class="stats-row" id="stats-row-mes">
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-people-fill"></i></span>
            <div class="main-value" id="stat_clients_month">0</div>
            <div class="label">Clientes</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-cash-stack"></i></span>
            <div class="main-value" id="stat_operations_month">0</div>
            <div class="label">Operaciones</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-currency-dollar"></i></span>
            <div class="main-value" id="stat_usd_month">$ 0.00</div>
            <div class="label">Monto USD</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-currency-exchange"></i></span>
            <div class="main-value" id="stat_pen_month">S/ 0.00</div>
            <div class="label">Monto Soles</div>
        </div>
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-graph-up"></i></span>
            <span id="utilidad_mes_valor" class="main-value"></span>
            <div class="label">Utilidad del mes</div>
        </div>

        <!-- Colocamos "Clientes Activos" aquí (toma el lugar de Meta) -->
        <div class="stats-card card-equal">
            <span class="icon"><i class="bi bi-person-check-fill"></i></span>
            <div class="main-value" id="stat_active_clients_month">0</div>
            <div class="label">Clientes activos</div>
        </div>

        <!-- "Meta" ahora aparece en la posición anterior de Clientes Activos y está destacada -->
        <div class="stats-card card-equal meta-card">
            <span class="icon"><i class="bi bi-bullseye"></i></span>
            <span id="meta_mes_valor" class="main-value"></span>
            <div class="label">Meta</div>
        </div>

        <div class="progress-card meta-card">
            <div class="progress-label"><i class="bi bi-bar-chart-steps"></i> Avance respecto a la meta</div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fg" id="meta_progress_bar" style="width:0%"></div>
            </div>
            <div id="meta_progress_text">0%</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let selectedMonth = ''; // Mes seleccionado (formato YYYY-MM)

// Función para generar opciones de meses
function generarOpcionesMeses() {
    const monthSelector = $('#monthSelector');
    monthSelector.empty();
    
    // Meses en español
    const meses = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    const ahora = new Date();
    const añoActual = ahora.getFullYear();
    const mesActual = ahora.getMonth(); // 0-11
    
    // Mes actual por defecto
    const mesActualStr = `${añoActual}-${(mesActual + 1).toString().padStart(2, '0')}`;
    selectedMonth = mesActualStr;
    
    // Agregar meses disponibles
    // Mes actual
    monthSelector.append(`<option value="${mesActualStr}">${meses[mesActual]} ${añoActual}</option>`);
            
    // También podemos agregar meses anteriores del año actual
    for (let i = mesActual - 1; i >= 0; i--) {
        const mesStr = `${añoActual}-${(i + 1).toString().padStart(2, '0')}`;
        monthSelector.append(`<option value="${mesStr}">${meses[i]} ${añoActual}</option>`);
    }
    
    // Configurar evento de cambio
    monthSelector.off('change').on('change', function() {
        selectedMonth = $(this).val();
        cargarDashboardTrader();
    });
}

function cargarDashboardTrader() {
    const params = {};
    if (selectedMonth) params.month = selectedMonth;
    
    $.getJSON('/api/dashboard_data', params, function(data){
        $('#stat_clients_today').text(data.clients_today);
        $('#stat_clients_month').text(data.clients_month);
        $('#stat_active_clients_month').text(data.active_clients_month);
        $('#stat_operations_today').text(data.operations_today);
        $('#stat_operations_month').text(data.operations_month);
        $('#stat_usd_today').text('$ ' + Number(data.usd_today).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#stat_pen_today').text('S/ ' + Number(data.pen_today).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#stat_usd_month').text('$ ' + Number(data.usd_month).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#stat_pen_month').text('S/ ' + Number(data.pen_month).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#utilidad_dia_valor').text('S/ ' + Number(data.utilidad_dia).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#utilidad_mes_valor').text('S/ ' + Number(data.utilidad_mes).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#meta_mes_valor').text('S/ ' + Number(data.meta_mes).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2}));
        $('#meta_progress_bar').css('width', data.avance + '%');
        $('#meta_progress_text').text(data.avance + '%');
    });
}

$(document).ready(function(){
    // Generar opciones de meses primero
    generarOpcionesMeses();
    
    // Luego cargar el dashboard
    cargarDashboardTrader();
    
    setInterval(cargarDashboardTrader, 4000);
});
</script>
{% endblock %}